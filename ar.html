<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#0b1021" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <title>AR Scene</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      }

      /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" */
      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 3000;
        padding: 12px 20px;
        min-height: 44px;
        border: none;
        border-radius: 12px;
        background: rgba(11, 16, 33, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #4ecdc4;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        touch-action: manipulation;
        transition: all 0.2s;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(78, 205, 196, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
        -webkit-appearance: none;
        appearance: none;
      }

      .back-button:active {
        transform: scale(0.95);
        background: rgba(11, 16, 33, 0.9);
      }

      /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
      .info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(11, 16, 33, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
        padding: 24px;
        padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
        z-index: 2000;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4);
        max-height: 70vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        border-top: 1px solid rgba(78, 205, 196, 0.2);
      }

      .info-panel.visible {
        transform: translateY(0);
      }

      .info-content {
        color: #fff;
      }

      .info-content h2 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #4ecdc4;
      }

      .info-content .subtitle {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
      }

      .info-content p {
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 24px;
        color: rgba(255, 255, 255, 0.85);
      }

      .close-button {
        width: 100%;
        padding: 16px 32px;
        min-height: 52px;
        border: none;
        border-radius: 16px;
        background: linear-gradient(135deg, #4ecdc4 0%, #44a8a0 100%);
        color: #0b1021;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        touch-action: manipulation;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 8px 24px rgba(78, 205, 196, 0.3);
        -webkit-appearance: none;
        appearance: none;
      }

      .close-button:active {
        transform: scale(0.98);
        box-shadow: 0 4px 16px rgba(78, 205, 196, 0.3);
      }

      /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ */
      .marker-hint {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(11, 16, 33, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 20px 32px;
        border-radius: 16px;
        color: #fff;
        text-align: center;
        border: 1px solid rgba(78, 205, 196, 0.3);
        pointer-events: none;
      }

      .marker-hint.hidden {
        display: none;
      }

      @media (max-width: 480px) {
        .back-button {
          top: 16px;
          left: 16px;
          padding: 10px 16px;
          font-size: 15px;
        }

        .info-panel {
          padding: 20px;
          padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        .info-content h2 {
          font-size: 24px;
        }

        .info-content .subtitle {
          font-size: 15px;
        }

        .info-content p {
          font-size: 15px;
        }
      }
    </style>
  </head>
  <body>
    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
    <button class="back-button" id="backButton">
      <span>‚Üê</span>
      <span>–ù–∞–∑–∞–¥</span>
    </button>

    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ -->
    <div class="marker-hint" id="markerHint">
      <p>üéØ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="infoPanel">
      <div class="info-content">
        <h2>–í–∏–∫—Ç–æ—Ä –í–∞—Å–Ω–µ—Ü–æ–≤</h2>
        <p class="subtitle">1848-1926</p>
        <p>–í–µ–ª–∏–∫–∏–π —Ä—É—Å—Å–∫–∏–π —Ö—É–¥–æ–∂–Ω–∏–∫, –º–∞—Å—Ç–µ—Ä –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –∏ —Ñ–æ–ª—å–∫–ª–æ—Ä–Ω–æ–π –∂–∏–≤–æ–ø–∏—Å–∏. –ï–≥–æ –∫–∞—Ä—Ç–∏–Ω–∞ "–ë–æ–≥–∞—Ç—ã—Ä–∏" (1898) ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö —É–∑–Ω–∞–≤–∞–µ–º—ã—Ö —à–µ–¥–µ–≤—Ä–æ–≤ —Ä—É—Å—Å–∫–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¢—Ä–µ—Ç—å—è–∫–æ–≤—Å–∫–æ–π –≥–∞–ª–µ—Ä–µ–µ –≤ –ú–æ—Å–∫–≤–µ.</p>
        <p>–í–∞—Å–Ω–µ—Ü–æ–≤ —Ä–∞–±–æ—Ç–∞–ª –Ω–∞–¥ —ç—Ç–∏–º –ø–æ–ª–æ—Ç–Ω–æ–º –ø–æ—á—Ç–∏ 20 –ª–µ—Ç. –ù–∞ –∫–∞—Ä—Ç–∏–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω—ã —Ç—Ä–∏ –±—ã–ª–∏–Ω–Ω—ã—Ö –±–æ–≥–∞—Ç—ã—Ä—è: –ò–ª—å—è –ú—É—Ä–æ–º–µ—Ü, –î–æ–±—Ä—ã–Ω—è –ù–∏–∫–∏—Ç–∏—á –∏ –ê–ª—ë—à–∞ –ü–æ–ø–æ–≤–∏—á, —Å—Ç–æ—è—â–∏–µ –Ω–∞ —Å—Ç—Ä–∞–∂–µ —Ä—É—Å—Å–∫–∏—Ö –∑–µ–º–µ–ª—å.</p>
        <button class="close-button" id="closeButton">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <!-- A-Frame AR Scene -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <img id="flag-image" src="https://artemvga.github.io/TENDER_TEST_AR/assets/images/Flag.png" crossorigin="anonymous" />
      </a-assets>

      <a-marker
        id="marker-flag"
        type="pattern"
        preset="custom"
        url="https://artemvga.github.io/TENDER_TEST_AR/assets/marker/Vasnecov.patt"
      >
        <a-image
          id="flag-sprite"
          src="#flag-image"
          scale="0.6 0.6 0.6"
          position="0 0 0"
          rotation="-90 0 0"
          transparent="true"
          visible="false"
        ></a-image>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –º–µ–Ω—é
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const fromMenu = urlParams.get('from') === 'menu';
        let hasAccess = fromMenu;

        if (!hasAccess) {
          try {
            const stored = localStorage.getItem('arData');
            if (stored) {
              const data = JSON.parse(stored);
              hasAccess = data.fromMenu === 'true';
              localStorage.removeItem('arData');
            }
          } catch (e) {
            console.log('Error checking access');
          }
        }

        if (!hasAccess) {
          window.location.href = 'index.html';
        }
      })();

      // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
      document.getElementById('backButton').addEventListener('click', function() {
        window.location.href = 'index.html';
      });

      // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ AR
      window.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector("a-scene");
        const infoPanel = document.getElementById("infoPanel");
        const closeButton = document.getElementById("closeButton");
        const markerHint = document.getElementById("markerHint");
        
        if (!scene || !infoPanel) return;

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏
        closeButton.addEventListener("click", () => {
          infoPanel.classList.remove("visible");
        });

        scene.addEventListener("loaded", () => {
          const marker = document.getElementById("marker-flag");
          const flag = document.getElementById("flag-sprite");

          if (!marker || !flag) return;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞
          marker.addEventListener("markerFound", () => {
            flag.setAttribute("visible", true);
            markerHint.classList.add("hidden");
          });

          marker.addEventListener("markerLost", () => {
            flag.setAttribute("visible", false);
            infoPanel.classList.remove("visible");
            markerHint.classList.remove("hidden");
          });

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
          let touchStartTime = 0;
          let touchStartPos = { x: 0, y: 0 };
          let lastTapTime = 0;

          const handleTouch = (event) => {
            if (!flag.getAttribute("visible")) return;

            const touch = event.touches?.[0] || event.changedTouches?.[0];
            if (!touch) return;

            const currentTime = Date.now();
            const currentPos = { x: touch.clientX, y: touch.clientY };

            if (event.type === "touchstart") {
              touchStartTime = currentTime;
              touchStartPos = currentPos;
            } else if (event.type === "touchend") {
              const timeDiff = currentTime - touchStartTime;
              const posDiff = Math.sqrt(
                Math.pow(currentPos.x - touchStartPos.x, 2) +
                Math.pow(currentPos.y - touchStartPos.y, 2)
              );

              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±—ã—Å—Ç—Ä—ã–π —Ç–∞–ø
              if (timeDiff < 300 && posDiff < 10) {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞
                if (currentTime - lastTapTime > 300) {
                  infoPanel.classList.add("visible");
                  lastTapTime = currentTime;
                }
              }
            }
          };

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
          scene.addEventListener("touchstart", handleTouch, { passive: true });
          scene.addEventListener("touchend", handleTouch, { passive: true });

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
          scene.addEventListener("click", (event) => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º
            if (event.target.closest('.back-button') || event.target.closest('.close-button')) {
              return;
            }
            
            if (flag.getAttribute("visible")) {
              infoPanel.classList.add("visible");
            }
          });
        });
      });
    </script>
  </body>
</html>